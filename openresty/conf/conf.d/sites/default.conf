server {
    listen 8080;
    server_name localhost;

    # Serve static assets (built JS libraries)
    location /assets/ {
        alias public/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Test endpoint
    location /test {
        default_type text/plain;
        return 200 "Hello, OpenResty is working!";
    }

    # Lua test endpoint
    location /lua {
        default_type text/plain;
        content_by_lua_block {
            ngx.say("Hello from Lua!")
            ngx.say("Current time: " .. os.date("%Y-%m-%d %H:%M:%S"))
        }
    }

    # Demo page to test injection (without upstream)
    location /demo {
        default_type text/html;
        content_by_lua_block {
            local html = [[
<!DOCTYPE html>
<html>
<head>
    <title>Injection Demo</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; }
        h1 { color: #333; }
    </style>
</head>
<body>
    <h1>Injection Demo Page</h1>
    <p>This page is served by OpenResty.</p>
    <p>Check the browser console and look for injected scripts!</p>
    <p>You should see:</p>
    <ul>
        <li>Blue banner at top (from runtime.js)</li>
        <li>Admin toolbar at bottom (from admin.js)</li>
    </ul>
</body>
</html>
            ]]
            
            -- Inject scripts
            local config = require("config")
            
            -- Build script tags
            local head_scripts = {}
            local body_scripts = {}
            
            local scripts = {
                { src = "/assets/js/runtime/1.0.0/runtime.min.js", position = "head", enabled = true },
                { src = "/assets/js/admin/1.0.0/admin.min.js", position = "body", enabled = true }
            }
            
            for _, script in ipairs(scripts) do
                if script.enabled then
                    local tag = string.format('<script src="%s" defer></script>\n', script.src)
                    if script.position == "head" then
                        table.insert(head_scripts, tag)
                    else
                        table.insert(body_scripts, tag)
                    end
                end
            end
            
            -- Inject before </head>
            if #head_scripts > 0 then
                local head_injection = table.concat(head_scripts, "")
                html = string.gsub(html, "</head>", head_injection .. "</head>", 1)
            end
            
            -- Inject before </body>
            if #body_scripts > 0 then
                local body_injection = table.concat(body_scripts, "")
                html = string.gsub(html, "</body>", body_injection .. "</body>", 1)
            end
            
            ngx.say(html)
        }
    }

    # Proxy to upstream and inject JavaScript
    location / {
        proxy_pass http://172.24.142.197:8000;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host:$server_port;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 86400;
    
        # Rewrite redirects to use proxy host
        proxy_redirect http://172.24.142.197:8000/ http://$host:$server_port/;
        proxy_redirect http://localhost:8000/ http://$host:$server_port/;
        proxy_redirect http://localhost/ http://$host:$server_port/;
    
        # Rewrite hardcoded localhost URLs in HTML/JS/CSS
        sub_filter 'http://localhost/' 'http://$host:$server_port/';
        sub_filter 'http://localhost:8000/' 'http://$host:$server_port/';
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
    
        # Conditionally buffer based on content type
        # Disable buffering for WebSocket upgrade requests
        proxy_buffering off;
        
        # Inject scripts into HTML responses only (not WebSocket)
        body_filter_by_lua_block {
            local inject = require("inject")
            inject.filter({
                scripts = {
                    { src = "/assets/js/runtime/1.0.0/runtime.min.js", position = "head", enabled = true },
                    { src = "/assets/js/admin/1.0.0/admin.min.js", position = "body", enabled = true }
                }
            })
        }
    }
}